/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   parse_color.c                                      :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: mdalloli <mdalloli@student.42.fr>          +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2025/10/29 14:11:14 by mdalloli          #+#    #+#             */
/*   Updated: 2025/10/29 16:04:21 by mdalloli         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "../cub3d.h"

/*Analizza una stringa RGB nel formato "R,G,B" e 
restituisce una struttura t_color
Ogni valore deve essere compreso tra 0 e 255, altrimenti genera un errore.*/
t_color parse_color(char *str)
{
	t_color	color;
	char	**split;
	
	split = ft_split(str, ',');
	if (!split || !split[0] || !split[1] || !split[2])
		print_error("Invalid color format");
	color.r = ft_atoi(split[0]);
	color.g = ft_atoi(split[1]);
	color.b = ft_atoi(split[2]);
	if (color.r < 0 || color.r > 255
		|| color.g < 0 || color.g > 255
		|| color.b < 0 || color.b > 255)
		print_error("Color out of range [0,255]");
	free_split(split);
	return (color);
}
/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   parse_file.c                                       :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: mdalloli <mdalloli@student.42.fr>          +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2025/10/29 14:11:17 by mdalloli          #+#    #+#             */
/*   Updated: 2025/10/29 16:05:26 by mdalloli         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "../cub3d.h"

/*Controlla che tutte le texture e i colori del pavimento e del soffitto
siano stati definiti correttamente, altrimenti genera un errore*/
static void	check_textures_and_colors(t_game *game)
{
	if (!game->textures.north || !game->textures.south
		|| !game->textures.west || !game->textures.east)
		print_error("Missing texture(s)");
	if (game->floor.r == -1 || game->ceiling.r == -1)
		print_error("Missing floor or ceiling color");
}

/*Legge e analizza un file .cub linea per linea, popolando la struttura t_game
Dopo il parsing verifica che texture e colori siano presenti e 
chiama validate_map().*/
int	parse_file(char *filename, t_game *game)
{
	int		fd;
	char	*line;

	fd = open(filename, O_RDONLY);
	if (fd < 0)
		print_error("Cannot open file");
	while ((line = get_next_line(fd)))
	{
		parse_line(line, game);
		free(line);
	}
	close(fd);
	check_textures_and_colors(game);
	validate_map(game);
	return(0);
}
/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   parse_line.c                                       :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: mdalloli <mdalloli@student.42.fr>          +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2025/10/29 14:11:21 by mdalloli          #+#    #+#             */
/*   Updated: 2025/10/29 16:06:33 by mdalloli         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "../cub3d.h"

/*Estrae il percorso della texture da una linea del tipo 
"NO ./path/to/texture.xpm"
Restituisce una copia della stringa del percorso*/
static char	*get_path(char *line)
{
	char	**split;
	char	*path;

	split = ft_split(line, ' ');
	if (!split || !split[1])
		print_error("Invalid texture path");
	path = ft_strdup(split[1]);
	free_split(split);
	return (path);
}

/*Analizza una singola linea del file .cub e 
aggiorna i campi corrispondenti di t_game
Riconosce texture, colori e inizio della mappa.*/
void	parse_line(char *line, t_game *game)
{
	if (is_empty_line(line))
		return ;
	else if (ft_strncmp(line, "NO ", 3) == 0)
		game->textures.north = get_path(line);
	else if (ft_strncmp(line, "SO ", 3) == 0)
		game->textures.south = get_path(line);
	else if (ft_strncmp(line, "WE ", 3) == 0)
		game->textures.west = get_path(line);
	else if (ft_strncmp(line, "EA ", 3) == 0)
		game->textures.east = get_path(line);
	else if (ft_strncmp(line, "F ", 2) == 0)
		game->floor = parse_color(line + 2);
	else if (ft_strncmp(line, "C ", 2) == 0)
		game->ceiling = parse_color(line + 2);
	else
	{
		game->map_started = 1;
		add_map_line(game, line);
	}
}
/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   parse_map.c                                        :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: francema <marvin@42.fr>                    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2025/10/29 14:11:23 by mdalloli          #+#    #+#             */
/*   Updated: 2025/11/05 16:26:17 by francema         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "../cub3d.h"

/*Aggiunge una riga alla mappa del gioco,
allocando l’array grid se non ancora esistente
Ogni chiamata inserisce una nuova riga duplicata e
incrementa l’altezza della mappa*/
void	add_map_line(t_game *game, char *line)
{
	static int	i = 0;

	if (!game->map.grid)
	{
		game->map.grid = ft_calloc(1000, sizeof(char *));
		game->map.height = 0;
	}
	game->map.grid[i++] = ft_strdup(line);
	game->map.height++;
}

/*Restituisce 1 se il carattere rappresenta una
direzione del giocatore (N, S, E o W), altrimenti restituisce 0.*/
static int	is_player_char(char c)
{
	return (c == 'N' || c == 'S' || c == 'E' || c == 'W');
}

/*Cerca la posizione iniziale del giocatore nella mappa e
la salva nella struttura t_game
Genera un errore se non viene trovata o se ce ne sono più di una.*/
static void	find_player(t_game *game)
{
	int	y;
	int	x;
	int	found = 0;

	y = -1;
	while (++y < game->map.height)
	{
		x = -1;
		while (game->map.grid[y][++x])
		{
			if (is_player_char(game->map.grid[y][x]))
			{
				if (found)
					print_error("Multiple player positions");
				found = 1;
				game->player.pos_x = x + 0.5;
				game->player.pos_y = y + 0.5;
				game->player.dir_x = game->map.grid[y][x];
			}
		}
	}
	if (!found)
		print_error("No player position found");
}

/*Controlla che la mappa sia completamente chiusa da muri
Se trova spazi aperti vicino a celle percorribili o al giocatore, genera un errore*/
static void	check_closed(t_game *game)
{
	int	y;
	int	x;

	y = 0;
	while (y < game->map.height)
	{
		x = 0;
		while (game->map.grid[y][x])
		{
			char c = game->map.grid[y][x];
			if (c == '0' || is_player_char(c))
			{
				if (y == 0 || x == 0
					|| !game->map.grid[y + 1]
					|| x >= (int)ft_strlen(game->map.grid[y + 1])
					|| game->map.grid[y - 1][x] == ' '
					|| game->map.grid[y][x - 1] == ' '
					|| game->map.grid[y][x + 1] == ' ')
					print_error("Map not closed by walls");
			}
			x++;
		}
		y++;
	}
}

/*Valida la mappa completa assicurandosi che ci sia un giocatore e
che sia chiusa da muri*/
void	validate_map(t_game *game)
{
	find_player(game);
	check_closed(game);
}
/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   parse_utils.c                                      :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: mdalloli <mdalloli@student.42.fr>          +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2025/10/29 14:11:26 by mdalloli          #+#    #+#             */
/*   Updated: 2025/10/29 16:01:04 by mdalloli         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "../cub3d.h"

/*Verifica se una linea e' vuota o composta solo da spazi, tab o newline
Restituisce 0 se la linea contiene altri caratteri, 
altrimenti restituisce la sua lunghezza*/
int	is_empty_line(char *line)
{
	int	i;

	i = 0;
	while (line[i])
	{
		if (line[i] != ' ' && line[i] != '\t' && line[i] != '\n')
			return (0);
		i++;
	}
	return (i);
}

/*Libera un array di stringhe terminato da NULL
Ogni stringa viene liberata singolarmente, 
poi viene liberato anche libera anche l'array principale*/
void	free_split(char **split)
{
	int i;
	
	if (!split)
		return ;
	i = 0;
	while (split[i])
		free(split[i++]);
	free(split);
}
